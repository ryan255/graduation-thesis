目   录
第一章 绪论	2
1.1 选题背景及意义	2
1.2 技术背景 3
1.3 在入侵检测应用中应用决策树分类算法的优点	6
1.4 本章小结	7
第二章 分布式架构的部署	8
第三章 网络入侵检测的决策树数据挖掘分析	9
结论（总结及展望）	10
致 谢	12
参考文献	13





# 基于kafka redis oracle 的分布式存储架构应用研究

吴瀚元

## 摘 要：

在大型电子商务网站业务量飞速增长的今天，传统的数据存储架构愈发的无法满足新时代电子商务网站在响应速度、可扩展性、容灾性等方面的需求。人们需要一种低成本的、可扩展的、高性能的大规模存储解决方案。数据库的种类众多，而其中以key-value数据库与传统关系型数据为代表，而key-value数据库中以redis为代表，关系型数据库以Oracle数据库为代表。本文主要是对大型存储的需求进行分析，针对电商网站的的特点，同时使用两种数据库并使用kafka作为中间件来同步数据，既利用了redis数据库易扩展高效率的特点，又利用传统数据库稳定性。这一改进，不但提高了电商网站的访问效率，而且还能够方便的与客户已有的IT系统对接。测试结果表明，本数据库存储架构的性能能够满足业务需求，与传统方式对比，效率大大提升。

关键字：kakfa；redis；oracle；数据库







## 第一章 绪论

### 1.1 选题背景及意义

随着电子商务网站的快速发展，客户量与业务量的急速增长给数据库提出了更多的要求，而传统的数据库架构存在体积臃肿、扩展性不足、效率低下等问题，而新型的key-value数据库在较小数据量时性能虽然高，但是性能受限于物理内存的限制，不能独立用作海量数据的高性能读写上。而且，一个大型的独立品牌电商网站在后台必然会与其原有IT系统的对接需求，单独某种单一数据库结构难以满足需求。

既然单独应用两种数据库都无法解决问题，那么将两者结合在一起就成为了我们的选择。而要将两者结合，其中最主要解决的问题就是数据同步。为了保证数据同步的实时性和扩展能力，我们需要一种可水平扩展和高效率的消息系统作为数据转发的中转站。这个系统就是kafka。

在本项目中，我们将redis中的数据变化发送给kafka集群，再由一个程序接收kafka消息队列并将数据写入另一个redis数据库。同时又另一个程序负责将数据写入oracle，从而解决了redis集群与oracle的数据同步问题。

本项目具有很高的现实意义，本系统已经在优衣库官网电商平台项目上得到实施，作为项目中的数据库架构，给前后端服务提供了稳定的、可扩展的支持。本架构弥补了行业中oracle数据库与redis数据库同步的技术空白，为以后相关架构的发展提供了可靠的依据。

### 1.2 技术背景

本项目中使用的技术主要有：redis、oracle数据库、kafka和spring-boot。

本项目使用Redis 3.2.5版本。Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制（replication）， LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction）， 事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过 Redis哨兵（Sentinel） 和自动 分区（Cluster）提供高可用性（high availability）。

本项目使用Oracle Database 11XE版本。Oracle Database，又名Oracle RDBMS，或简称Oracle。是甲骨文公司的一款关系数据库管理系统。它是在数据库领域一直处于领先地位的产品。可以说Oracle数据库系统是目前世界上流行的关系数据库管理系统，系统可移植性好、使用方便、功能强，适用于各类大、中、小、微机环境。它是一种高效率、可靠性好的 适应高吞吐量的数据库解决方案。

本项目使用kafka 0.10.2.0版本。Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者规模的网站中的所有动作流数据。 这种动作（网页浏览，搜索和其他用户的行动）是在现代网络上的许多社会功能的一个关键因素。 

![kafka-apis](/Users/wuhanyuan/githubproject/graduation-thesis/kafka-apis.png)

它最初由LinkedIn公司开发，之后成为Apache项目的一部分。通常被用作构建实时的数据通道，它是水平可扩展的，分布式的，快速的。

本项目使用Spring-Boot 1.4.0版本。Spring Boot是Spring社区较新的一个项目。该项目的目的是帮助开发者更容易的创建基于Spring的应用程序和服务，让更多人的人更快的对Spring进行入门体验，让Java开发也能够实现Ruby on Rails那样的生产效率。为Spring生态系统提供了一种固定的、约定优于配置风格的框架。Spring Boot具有如下特性：

1. 为基于Spring的开发提供更快的入门体验
2. 开箱即用，没有代码生成，也无需XML配置。同时也可以修改默认值来满足特定的需求。
3. 提供了一些大型项目中常见的非功能性特性，如嵌入式服务器、安全、指标，健康
4. Spring Boot并不是不对Spring功能上的增强，而是提供了一种快速使用Spring的方式。

spring-boot的应用大大减少了开发中的配置任务，加快了开发进程。而且它提供的spring-data-redis库为操作redis数据库提供了良好的支持。

另外，本项目使用maven作为项目构建工具，使用github作为版本控制工具。

### 1.3 本章小结

本章介绍了开发本数据库架构的背景及意义，同时也指出了开发中要解决的核心问题是数据同步。简要介绍了本项目中使用到的主要技术及其技术背景。结合项目中对技术的实际使用，在技术介绍中分析了使用相关技术路线的优势。

## 第二章 分布式架构的部署

### 2.1 整体结构说明 

![hmall数据同步流程-从redis1操作](/Users/wuhanyuan/githubproject/graduation-thesis/hmall数据同步流程-从redis1操作.png)

项目的整体结构如图2-1所示。本项目中涉及分布式部署的模块有kafka与redis两种。为了降低组建之间的耦合度提高稳定性和扩展性，项目中使用了2个kafka集群作为数据中间件，负责数据的转发。mirrirmaker是一个kafka的组件，能够实现两个kafka集群中的数据复制。左右两侧两个redis数据库集群，代表应用环境中两个不同地理位置的数据中心，而下方的oracle数据库则作为备份数据库使用。

### 2.2 kafka集群

Kafka的整体架构是显式分布式架构，producer、broker（kafka）和consumer都可以有多个。Producer，consumer实现Kafka注册的接口，数据从producer发送到broker，broker承担一个中间缓存和分发的作用。broker分发注册到系统中的consumer。broker的作用类似于缓存，即活跃的数据和离线处理系统之间的缓存。客户端和服务器端的通信，是基于简单，高性能，且与编程语言无关的TCP协议。几个基本概念：

1. Topic：特指Kafka处理的消息源（feeds of messages）的不同分类。
2. Partition：Topic物理上的分组，一个topic可以分为多个partition，每个partition是一个有序的队列。partition中的每条消息都会被分配一个有序的id（offset）。
3. Message：消息，是通信的基本单位，每个producer可以向一个topic（主题）发布一些消息。
4. Producers：消息和数据生产者，向Kafka的一个topic发布消息的过程叫做producers。
5. Consumers：消息和数据消费者，订阅topics并处理其发布的消息的过程叫做consumers。
6. Broker：缓存代理，Kafa集群中的一台或多台服务器统称为broker。

在本项目中，每个kakfa集群有由3个kafka-server与一个zookeeper组成。每个数据流动方向使用一个独立的Topic，比如从redis1到redis2的数据流使用一个叫test1的topic。Producers与Consumers则通过kafka提供的java的api来实现。发送的Message即为数据同步所需的数据变化信息（主要包含add、update、delete三种操作类型及其数据）。



### 2.3 redis集群

redis集群部署非常简单。修改redis.conf中关于数据库集群节点以及IP地址与端口的相关配置，重新启动redis数据库即可。在应用环境中，每个redis集群由三台redis服务器节点组成。而在生产环境中，受限于设备硬件性能，我们使用单节点的伪集群部署。

### 2.4 本章小结

本章主要介绍了项目在架构上的整体设计，着重介绍了kakfa集群的几个基本概念。同时描述了kafka与redis在本项目中的部署情况。环境的部署为整个项目的运作提供了基础支持，而项目的可扩展性也依赖于这些组件本身。

##第三章 数据同步

### 3.1 数据

解决数据同步问题要先考虑数据是如何产生的。对于本项目的应用背景（一个电商平台）而言，数据操作无非是add、update和delete的组合。所以，只要能收集到操作类型、操作的目标（oracle中的表或者redis中的HashValue）、操作的数据（每个字段以及对应的值），我们就可以将数据原封不动的“同步”到另一个数据库中。在这里同步的本质不是复制，而是将数据操作原样执行了一遍。这就是本项目中数据同步的基本原理。

在实现中，用户在对redis1进行操作的时候，数据的增量信息（操作类型、操作的目标、数据）就会插入到redis中的一个队列（从左向右，先进先出）里。随后再由程序从右侧弹出队列，并将信息发送到Kafka集群中。

### 3.2 消息的顺序

kafka只能保证一个partition中的消息被某个consumer消费时，消息是顺序的。事实上，从Topic角度来说，消息仍不是有序的。如果你需要topic范围内的有序，那么你可以只使用一个partition，这也就是说，group中也只有一个consumer。但是在应用情况中，为了提高性能保证速度，producer与consumer都是多线程的，也就是说，同时有多个producer在生产数据，也同时有多个consumer在消费数据。这就会导致数据的无序。

add、updtae、delete数据的操作顺序的改变很明显会导致最终结果的不同，所以需要有一种机制来保证即使数据顺序不同，最终结果也是一样的。这里我们引入了“伪删除”，即删除操作是将数据从原表删除的同时存入另外一张我们称之为“删除表”的表中。下面给出三种操作类型的流程图：

add：

![hmall数据操作-add](/Users/wuhanyuan/githubproject/graduation-thesis/hmall数据操作-add.png)

update：

![hmall数据操作-update](/Users/wuhanyuan/githubproject/graduation-thesis/hmall数据操作-update.png)

delete：

![hmall数据操作-delete](/Users/wuhanyuan/githubproject/graduation-thesis/hmall数据操作-delete.png)

通过上述三种数据操作类型的逻辑设计，我们解决了数据同步中kafka的无序问题。

### 3.3 本章小结

因为数据同步是本架构要解决的最核心问题，本章主要介绍了数据同步的基本原理，着重介绍了kafka无序问题的解决。这个问题的解决打通了多个数据中心之间数据同步的通道。

## 第四章 测试于性能

### 4.1 性能指标



## 结论（总结及展望）

此次研究中，主要是基于网络入侵检测的具体数据挖掘，应用C4.5决策树分类算法对KDDCup1999数据集进行数据挖掘，主要是针对于网络入侵中不必要的正常数据进行排除，只利用了异常数据对数据进行分类挖掘的角度，对C4.5算法做了改进。改进的结果也显示，没有影响网络入侵模型的准确度，同时还大大的提高了C4.5算法在对网络入侵模型进行挖掘的时间效率。
但是这次研究也有不足的地方，首先，目前C4.5对KDDCup1999分析出的决策树中，还存在很多空枝，也就是没有符合此路径的实例。这一点还需要继续研究C4.5算法，从算法的建树模块或者剪枝模块进行改进，应该可以得到一棵更准确的决策树。
再者，如果可以结合多种数据挖掘算法，我们可以得到更细致的知识。例如，可以将关联分析规则加入到C4.5算法中，则就可以得到更多关于网络入侵的模式，这将更有效的帮助人们防范与预测网络入侵。













致 谢
在这次做毕业设计的整个过程中，我要感谢的人有很多。
我首先要感谢我的指导老师。当我迷惑在途中不知所向的时，是指导老师及时给了我指点，让我及时更正了研究方向，我才能及时，高效的完成我的毕业设计。指导老师非常负责地协助我走完了整个过程。真心的谢谢您。
其次要感谢我们学院的XXx老师，他们在数据挖掘方面给了我很多指导和帮助，使我少走了许多弯路。
还要谢谢的就是我身边的很多同学，我在实际研究的过程中，遇到了一些问题，是他们帮助了我，也让我学到了许多东西。
谢谢你们！














参考文献
[1] Jiawei han， Micheline Kamber. 《DATA DMINING: Concepts and Techniques》[M]. 北京：高等教育出版社.2001
[2] 毛国君，段立娟，王实等. 《数据挖掘原理与算法》[M]. 北京：清华大学出版社.2005
[3] 史忠植. 《知识发现》[M]. 北京：清华大学出版社.2002
[4] 闪四清，陈茵，程雁等. 《数据挖掘——概念、模型、方法和算法》[M]. 北京：清华大学出版社.2003
[5] W.Lee S.J.Stolfo, K.W.Mok. “Mining in a data-flow covironment, Experience in Network intrusion detection. In Proceeding of the ACM SIGKDD International Conference on Knowledge Discovery&Data Mining”. 1999,112-115
[6] Porter B W, Baress E R, Holte R. “Concept learning and heuristic classification in weak theory domains”. Artificial Intelligence,1989,45(1/2):56～58
[7] Breiman L，Friedman J，OIshen R A，Stone C J，“Classification and regression trees”
. Belmont: Wadsworth, 1984:1-358.
[8] KDDCup1999. 
http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html
[9] C4.5 Tutorial. 
http://www2.cs.uregina.ca/~dbd/cs831/notes/ml/dtrees/c4.5/c4.5.html
[10] 凌昊. 《基于决策树分类算法的网络入侵检测系统的研究》. 2007
[11] 关晓蔷. 《基于决策树的分类算法研究》. 2006
[12] 卜亚杰. 《决策树分类算法的研究及应用》. 2007
[13] 迟庆云. 《基于决策树的分类算法研究与应用》. 2005
[14] 郭爱伟. 《入侵检测系统分类算法的研究》. 2006
[15] 王一萍，于利，闫孚等. 《运用C4.5 算法优化入侵检测系统的研究》. 高师理科学刊. 2007
[16] 袁爱香. 《C4. 5数据挖掘算法的改进及其应用》. 山东农业大学学报. 2008